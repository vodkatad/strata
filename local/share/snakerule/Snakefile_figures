SRC_DIR="../../local/src"
DATA_DIR="../../local/share/data"
HR_MUTS=DATA_DIR+"/new_gatk/merged.table_nomultiallele_CRC00578"
HR_MUTS_ANNOT=DATA_DIR+"/new_gatk/merged.hg38_multianno.txt"
DICTIO_CRC=DATA_DIR+"/PJ1903090-SF-Integragen-Targeted-Seq_no578.tsv"

rule cases:
    input: DICTIO_CRC
    output: "all_cases_hr.tsv"
    shell:
        """
           cut -f 1 {input} | sed 1d | tr "_" "\\t" | cut -f 2 | bawk '{{print substr($1,0,7)}}' > {output}
        """

rule cases_long:
    input: DICTIO_CRC
    output: "all_cases_hr_long.tsv"
    shell:
        """
           cut -f 1 {input} | sed 1d | tr "_" "\\t" | cut -f 2  > {output}
        """

# the corresponding rule for biobanca targeted data could pick the top 10 mutated genes with VAF > 0.05 and then add Livio's requests (xeno's data, but check
# your notes because I am not 100% sure).
# will print genes without any nonsyn mut
rule convert_to_binary_gene_sample_mat:
    input: mut=HR_MUTS, annot=HR_MUTS_ANNOT, all_models="all_cases_hr.tsv"
    params: thr=0.05
    output: mat="binary_gene_mat.tsv"
    script: SRC_DIR+"/binarize_hr.R"

# couple check vs old longformat:
#egrassi@godot:/mnt/trcanmed/snaketree/prj/strata/dataset/figures$ grep -w MUS81 ../targeted_hr_our_july_2021/gene_annot_muts.tsv 
#egrassi@godot:/mnt/trcanmed/snaketree/prj/strata/dataset/figures$ bawk '$2!=0{print $1,$2}' binary_gene_mat.tsv
#+ATR

# we need files with CRC models to retain only good models ordered like waterfall3/waterfall6: ./wf_chemio_3_6.txt temporary from MarcoA's mail waterfall chemio 11/07/23
rule wf_chemio:
    input: DATA_DIR+"/wf_chemio_3_6.txt"
    output: w6="w6_waterfall.tsv",w3="w3_waterfall.tsv"
    shell: 
        """
           cut -f 1,2 {input} | grep -v CASE | sort -gk2,2 -r > {output.w3}  
           bawk '$3!=""{{print $1,$3}}' {input} | grep -v CASE| sort -gk2,2 -r > {output.w6}  
        """

rule hr_oncoprint:
    input: mutmat="binary_gene_mat.tsv", wf="{week}_waterfall.tsv"
    output: op="{week}_hr_oncoprint.pdf", op_data="{week}_hr_oncoprint.Rdata", opwf="{week}_hr_oncoprintwf.pdf", opmute="{week}_hr_oncoprintmute.pdf"
    script: SRC_DIR+"/oncoprint_binary.R"

# colored oncoprint for hr
rule convert_to_ndel_gene_sample_mat:
    input: mut=HR_MUTS, annot=HR_MUTS_ANNOT, all_models="all_cases_hr.tsv"
    params: thr=0.05
    output: mat="nDel_gene_mat.tsv"
    script: SRC_DIR+"/ndel_hr.R"


rule hr_oncoprint_countdel:
    input: mutmat="nDel_gene_mat.tsv", wf="{week}_waterfall.tsv"
    output: op="{week}_hr_oncoprintndel.pdf", op_data="{week}_hr_oncoprintndel.Rdata", opwf="{week}_hr_oncoprintndelwf.pdf", opmute="{week}_hr_oncoprintndelmute.pdf"
    script: SRC_DIR+"/oncoprint_ndel.R"

# biobanca's data

# put together suppl table 2